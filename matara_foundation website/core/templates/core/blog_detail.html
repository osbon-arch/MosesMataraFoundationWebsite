{% extends "core/base.html" %}
{% load static %}
{% load embed_video_tags %}

{% block content %}
<section class="py-5 bg-light">
  <div class="container">
    <!-- Featured Image -->
    {% if post.image %}
    <div class="text-center mb-5 animate-fade-in">
      <img 
        src="{{ post.image.url }}" 
        alt="{{ post.title }}" 
        class="img-fluid rounded-4 shadow-lg w-100" 
        style="max-height: 480px; object-fit: cover;"
      >
    </div>
    {% endif %}

    <!-- Video Section -->
    {% if post.video %}
    <div class="video-container mb-5 rounded-4 overflow-hidden shadow-lg animate-slide-up">
      {% video post.video 'large' %}
    </div>
    {% endif %}

    <!-- Title -->
    <div class="text-center animate-slide-up">
      <h1 class="fw-bold text-warning mb-2 display-6">{{ post.title }}</h1>
      <p class="text-muted small">
        By <strong>{{ post.author }}</strong> Â· {{ post.created_at|date:"F j, Y" }}
      </p>
      <hr class="w-25 mx-auto border-warning opacity-75">
    </div>

    <!-- Blog Content -->
    <div class="mt-5 lead text-secondary animate-fade-in lh-lg">
      {{ post.content|safe }}
    </div>

    <!-- Social Share -->
    <div class="text-center my-5 animate-slide-up">
      <p class="fw-semibold mb-3 text-dark">Share this story:</p>
      <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" target="_blank" class="btn btn-outline-primary btn-sm me-2 hover-lift">Facebook</a>
      <a href="https://twitter.com/intent/tweet?url={{ request.build_absolute_uri }}" target="_blank" class="btn btn-outline-info btn-sm me-2 hover-lift">X (Twitter)</a>
      <a href="https://api.whatsapp.com/send?text={{ request.build_absolute_uri }}" target="_blank" class="btn btn-outline-success btn-sm hover-lift">WhatsApp</a>
    </div>
<!-- Comments Section -->
<div id="comments-section" class="mt-5 animate-fade-in">
  <h4 class="fw-bold text-dark mb-4">ðŸ’¬ Comments</h4>

  <!-- Comment Form -->
  <form id="comment-form" method="POST" class="mb-5 p-4 rounded-4 shadow-sm bg-white border border-warning-subtle">
    {% csrf_token %}
    <div class="mb-3">
      <input type="text" name="name" class="form-control rounded-pill shadow-sm" placeholder="Your name" required>
    </div>
    <div class="mb-3">
      <textarea name="message" class="form-control rounded-4 shadow-sm" rows="3" placeholder="Write a comment..." required></textarea>
    </div>
    <button type="submit" class="btn btn-warning text-dark fw-semibold px-4 rounded-pill shadow-sm hover-lift">
      Post Comment
    </button>
  </form>

  <!-- Comments -->
  <div id="comments-list">
    {% for comment in comments %}
    <div class="comment-block border-start border-3 border-warning ps-3 mb-4 animate-fade-in" data-id="{{ comment.id }}">
      <strong>{{ comment.name }}</strong>
      <span class="text-muted small">{{ comment.created_at|date:"F j, Y, g:i a" }}</span>
      <p class="mt-2">{{ comment.message }}</p>

      <!-- Reply Button -->
      <button class="btn btn-link text-warning p-0 small toggle-reply" data-target="reply-{{ comment.id }}">Reply</button>

      <!-- Reply Form (Hidden) -->
      <form class="reply-form mt-2 p-3 rounded bg-light border border-warning-subtle" 
            id="reply-{{ comment.id }}" 
            method="POST" style="display:none;">
        {% csrf_token %}
        <input type="hidden" name="parent_id" value="{{ comment.id }}">
        <input type="text" name="name" class="form-control form-control-sm mb-2" placeholder="Your name" required>
        <textarea name="message" class="form-control form-control-sm mb-2" rows="2" placeholder="Write a reply..." required></textarea>
        <button type="submit" class="btn btn-sm btn-warning text-dark rounded-pill">Reply</button>
      </form>

      <!-- Replies -->
      <div class="ms-4 mt-2" id="replies-{{ comment.id }}">
        {% for reply in comment.children %}
        <div class="mt-3 p-3 bg-white rounded border-start border-warning animate-fade-in">
          <strong>{{ reply.name }}</strong>
          <span class="text-muted small">{{ reply.created_at|date:"F j, Y, g:i a" }}</span>
          <p class="mt-2">{{ reply.message }}</p>
        </div>
        {% endfor %}
      </div>
    </div>
    {% empty %}
    <p class="text-muted">No comments yet. Be the first to share your thoughts!</p>
    {% endfor %}
  </div>
</div>

<script>
  // Toggle reply form
  document.querySelectorAll('.toggle-reply').forEach(btn => {
    btn.addEventListener('click', () => {
      const target = document.getElementById(btn.dataset.target);
      target.style.display = target.style.display === 'none' ? 'block' : 'none';
    });
  });

  // AJAX submit helper
  function ajaxSubmit(form, targetId) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const response = await fetch("", {
        method: "POST",
        headers: { "X-Requested-With": "XMLHttpRequest" },
        body: formData
      });
      const data = await response.json();
      if (data.html) {
        document.getElementById(targetId).insertAdjacentHTML("beforeend", data.html);
        form.reset();
        form.style.display = "none";
      }
    });
  }

  // Main comment form
  ajaxSubmit(document.getElementById("comment-form"), "comments-list");

  // Reply forms
  document.querySelectorAll(".reply-form").forEach(form => {
    const parentId = form.querySelector("input[name='parent_id']").value;
    ajaxSubmit(form, "replies-" + parentId);
  });
</script>


<!-- Custom Animations -->
<style>
  .animate-fade-in {
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.8s ease;
  }
  .animate-slide-up {
    opacity: 0;
    transform: translateY(50px);
    transition: all 0.9s ease;
  }
  .hover-lift:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
  }
  .visible {
    opacity: 1 !important;
    transform: translateY(0) !important;
  }
  .video-container iframe {
    width: 100%;
    height: 450px;
    border: none;
  }
</style>

<!-- Scroll Animation Script -->
<script>
  const elements = document.querySelectorAll('.animate-fade-in, .animate-slide-up');
  const observer = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('visible');
        observer.unobserve(entry.target);
      }
    });
  }, { threshold: 0.2 });
  elements.forEach(el => observer.observe(el));
</script>
{% endblock %}
